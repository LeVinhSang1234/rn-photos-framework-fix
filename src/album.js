import{NativeModules,Platform}from"react-native";import ImageAsset from"./image-asset";import uuidGenerator from"./uuid-generator";import{assetArrayObserverHandler}from"./change-observer-handler";import EventEmitter from"../event-emitter";const RNPFManager=NativeModules.RNPFManager;if(!RNPFManager&&"ios"===Platform.OS)throw new Error("Could not find rn-photos-framework's native module. It seems it's not linked correctly in your xcode-project.");const ImageAssetApi=new ImageAsset;export default class Album extends EventEmitter{constructor(e,t,s){super(),this._fetchOptions=t,Object.assign(this,e),this.previewAssets&&(this.previewAssets=this.previewAssets.map(ImageAssetApi.createJsAsset),this.previewAssets.length&&(this.previewAsset=this.previewAssets[0])),s.addListener("onObjectChange",(e=>{e._cacheKey===this._cacheKey&&this._emitChange(e,((t,s,r)=>t?assetArrayObserverHandler(e,t,ImageAssetApi.createJsAsset,((e,t)=>this.newAssetsRequested(e,r,t)),this.perferedSortOrder).then((e=>(s&&s(e),e))):t),this)}))}newAssetsRequested(e,t,s){const r={...t,indecies:[...e]};return this.getAssetsWithIndecies(r).then((e=>(s&&s(e),e)))}deleteContentPermitted(){return this._canPerformOperation(0)}removeContentPermitted(){return this._canPerformOperation(1)}addContentPermitted(){return this._canPerformOperation(2)}createContentPermitted(){return this._canPerformOperation(3)}reArrangeContentPermitted(){return this._canPerformOperation(4)}deletePermitted(){return this._canPerformOperation(5)}renamePermitted(){return this._canPerformOperation(6)}_canPerformOperation(e){return this.permittedOperations&&this.permittedOperations[e]}stopTracking(){return new Promise(((e,t)=>{if(this._cacheKey)return e(RNPFManager.stopTracking(this._cacheKey));e({success:!0,status:"was-not-tracked"})}))}getAssets(e){return this.perferedSortOrder=e.assetDisplayBottomUp===e.assetDisplayStartToEnd?"reversed":"normal",(e.trackInsertsAndDeletes||e.trackAssetsChanges)&&!this._cacheKey&&(this._cacheKey=uuidGenerator()),this.getAssetsEvent({fetchOptions:this._fetchOptions,...e,_cacheKey:this._cacheKey,albumLocalIdentifier:this.localIdentifier})}getAssetsEvent(e){return e&&e.fetchOptions&&void 0===e.assetDisplayStartToEnd&&e.fetchOptions.sortDescriptors&&e.fetchOptions.sortDescriptors.length&&(e.assetDisplayStartToEnd=!0),RNPFManager.getAssets(e).then((e=>({assets:e.assets.map(ImageAssetApi.createJsAsset),includesLastAsset:e.includesLastAsset})))}getAssetsWithIndecies(e){return(e.trackInsertsAndDeletes||e.trackAssetsChanges)&&!this._cacheKey&&(this._cacheKey=uuidGenerator()),RNPFManager.getAssetsWithIndecies({fetchOptions:this._fetchOptions,...e,_cacheKey:this._cacheKey,albumLocalIdentifier:this.localIdentifier}).then((e=>e.assets.map(ImageAssetApi.createJsAsset)))}addAsset(e){return this.addAssets([e])}addAssets(e){return RNPFManager.addAssetsToAlbum({assets:e.map((e=>e.localIdentifier)),_cacheKey:this._cacheKey,albumLocalIdentifier:this.localIdentifier})}removeAsset(e){return this.removeAssets([e])}removeAssets(e){return RNPFManager.removeAssetsFromAlbum({assets:e.map((e=>e.localIdentifier)),_cacheKey:this._cacheKey,albumLocalIdentifier:this.localIdentifier})}updateTitle(e){return RNPFManager.updateAlbumTitle({newTitle:e,_cacheKey:this._cacheKey,albumLocalIdentifier:this.localIdentifier})}delete(){return RNPFManager.deleteAlbums([this.localIdentifier])}onChange(e){const t=this.addListener("onChange",e);return()=>t?.remove?.()}_emitChange(...e){this.emit("onChange",...e)}}